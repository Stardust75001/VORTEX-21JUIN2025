name: Deploy to Shopify

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Shopify CLI
        run: npm install -g @shopify/cli @shopify/theme

      - name: Validate theme
        env:
          SHOPIFY_CLI_AUTH_TOKEN: ${{ secrets.SHORTLY_PASSWORD }}
        run: shopify theme check

      - name: Deploy theme to Shopify
        env:
          SHOPIFY_CLI_AUTH_TOKEN: ${{ secrets.SHORTLY_PASSWORD }}
        run: |
          echo "ðŸš€ DÃ©ploiement vers Shopify..."
          echo "Boutique: thepetsociety.paris"
          echo "ID du thÃ¨me: ${{ secrets.SHORTLY_THERE_ID }}"
          
          shopify theme push \
            --path=. \
            --store=thepetsociety.paris \
            --theme=${{ secrets.SHORTLY_THERE_ID }} \
            --allow-live \
            --verbose
          
          echo "âœ… DÃ©ploiement rÃ©ussi!"

  notify_failure_if_any:
    needs: deploy
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Notify Sentry of failure
        run: |
          echo "ðŸš¨ Envoi de la notification d'Ã©chec Ã  Sentry"
          
          # GÃ©nÃ©rer l'event ID
          EVENT_ID=$(uuidgen)
          
          # CrÃ©er le payload au format correct pour Sentry
          PAYLOAD=$(cat <<EOF
          {
            "event_id": "$EVENT_ID",
            "timestamp": $(date +%s),
            "platform": "other",
            "message": "Ã‰chec du dÃ©ploiement Shopify via GitHub Actions",
            "level": "error",
            "logger": "github-actions",
            "server_name": "github-actions",
            "release": "${{ github.sha }}",
            "tags": {
              "workflow": "${{ github.workflow }}",
              "repository": "${{ github.repository }}"
            },
            "extra": {
              "run_id": "${{ github.run_id }}",
              "run_number": "${{ github.run_number }}"
            }
          }
          EOF
          )
          
          # Envoyer la requÃªte Ã  Sentry
          curl -v -X POST "https://o4509330673303552.ingest.sentry.io/api/4509534073585744/envelope/" \
            -H "Content-Type: application/x-sentry-envelope" \
            -H "Authorization: DSN ${{ secrets.SHORTLY_STORE }}" \
            -d "$PAYLOAD"
          
          echo "ðŸ“¬ Notification envoyÃ©e Ã  Sentry"
